<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRK Generator - Test Runner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-pass { color: green; }
        .test-fail { color: red; }
        .test-suite { margin-left: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .summary { margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>KRK Generator - Test Runner</h1>
        <div id="test-results"></div>
        <div id="summary" class="summary">
            <h3>Ringkasan Pengujian</h3>
            <div>Total: <span id="total-tests">0</span></div>
            <div>Berhasil: <span id="passed-tests">0</span></div>
            <div>Gagal: <span id="failed-tests">0</span></div>
            <div>Waktu Eksekusi: <span id="execution-time">0</span>ms</div>
        </div>
    </div>

    <!-- Test files -->
    <script type="module">
        // Import test files
        import { securityUtils } from '../assets/js/utils/security.js';
        
        // Expose to global for testing
        window.securityUtils = securityUtils;
    </script>
    
    <!-- Test framework -->
    <script src="https://unpkg.com/chai/chai.js"></script>
    <script src="https://unpkg.com/mocha/mocha.js"></script>
    <script>
        // Configure Mocha
        mocha.setup('bdd');
        const { expect } = chai;
        
        // Test variables
        const testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            startTime: Date.now()
        };
        
        // Test reporter
        const TestReporter = function(runner) {
            const results = document.getElementById('test-results');
            
            runner.on('suite', function(suite) {
                if (suite.root) return;
                const suiteDiv = document.createElement('div');
                suiteDiv.className = 'test-suite';
                suiteDiv.innerHTML = `<h3>${suite.title}</h3>`;
                results.appendChild(suiteDiv);
                suite.suiteDiv = suiteDiv;
            });
            
            runner.on('pass', function(test) {
                testResults.passed++;
                testResults.total++;
                
                const testDiv = document.createElement('div');
                testDiv.className = 'test-result test-pass';
                testDiv.textContent = `✓ ${test.title}`;
                test.parent.suiteDiv.appendChild(testDiv);
                
                updateSummary();
            });
            
            runner.on('fail', function(test, err) {
                testResults.failed++;
                testResults.total++;
                
                const testDiv = document.createElement('div');
                testDiv.className = 'test-result test-fail';
                testDiv.innerHTML = `
                    <div>✗ ${test.title}</div>
                    <div class="text-muted">${err.message}</div>
                    <pre style="font-size: 12px; color: #666">${err.stack}</pre>
                `;
                test.parent.suiteDiv.appendChild(testDiv);
                
                updateSummary();
            });
            
            function updateSummary() {
                document.getElementById('total-tests').textContent = testResults.total;
                document.getElementById('passed-tests').textContent = testResults.passed;
                document.getElementById('failed-tests').textContent = testResults.failed;
                document.getElementById('execution-time').textContent = Date.now() - testResults.startTime;
            }
        };
        
        // Add custom reporter
        mocha.reporter(TestReporter);
        
        // Run tests when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Add test files here
            mocha.suite.suites = [];
            
            // Load and run security tests
            const securityTests = document.createElement('script');
            securityTests.src = 'tests/unit/security-tests.js';
            securityTests.onload = function() {
                mocha.run();
            };
            document.head.appendChild(securityTests);
        });
    </script>
</body>
</html>
